async function reportHandler(ctx) {
  try {
    const telegramId = ctx.from.id;
    const reportText = ctx.message.text;

    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
    if (reportText.startsWith('/')) {
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É –æ—Ç—á–µ—Ç–∞
    if (reportText.trim().length < 5) {
      return ctx.reply(`üìù –û—Ç—á–µ—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π!

–ú–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤. –û–ø–∏—à–∏—Ç–µ:
‚Ä¢ –ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —Å–¥–µ–ª–∞–ª–∏ —Å–µ–≥–æ–¥–Ω—è?
‚Ä¢ –ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–∏–ª–∏?
‚Ä¢ –ë—ã–ª–∏ –ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –∏–ª–∏ –≤–æ–ø—Ä–æ—Å—ã?

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ üëá`);
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É
    if (reportText.length > 2000) {
      return ctx.reply(`üìù –û—Ç—á–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π!

–ú–∞–∫—Å–∏–º—É–º 2000 —Å–∏–º–≤–æ–ª–æ–≤. –ü–æ—Å—Ç–∞—Ä–∞–π—Ç–µ—Å—å –±—ã—Ç—å –±–æ–ª–µ–µ –∫—Ä–∞—Ç–∫–∏–º, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º.

–¢–µ–∫—É—â–∞—è –¥–ª–∏–Ω–∞: ${reportText.length} —Å–∏–º–≤–æ–ª–æ–≤`);
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –≤ API
    try {
      const response = await fetch(`${process.env.API_BASE_URL || 'http://localhost:3000'}/api/bot/end-day`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          telegram_id: telegramId,
          content: reportText.trim()
        })
      });

      const data = await response.json();

      if (data.success) {
        await ctx.reply(`‚úÖ ${data.message}

üìä *–í–∞—à –æ—Ç—á–µ—Ç –ø—Ä–∏–Ω—è—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω*

üïê –†–∞–±–æ—á–∏–π –¥–µ–Ω—å –∑–∞–≤–µ—Ä—à–µ–Ω
üìù –û—Ç—á–µ—Ç: ${Math.min(reportText.length, 100)}${reportText.length > 100 ? '...' : ''} —Å–∏–º–≤–æ–ª–æ–≤

–°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–∞–±–æ—Ç—É! –î–æ –≤—Å—Ç—Ä–µ—á–∏ –∑–∞–≤—Ç—Ä–∞ üëã`, 
          { parse_mode: 'Markdown' });

      } else {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
        if (data.error.includes('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–º–µ—Ç—å—Ç–µ—Å—å')) {
          ctx.reply(`‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å –Ω–∞—á–∞–ª–æ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è!

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /status –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –∏–ª–∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.`);
        } else if (data.error.includes('—É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω')) {
          ctx.reply(`‚ÑπÔ∏è –†–∞–±–æ—á–∏–π –¥–µ–Ω—å —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω –∏ –æ—Ç—á–µ—Ç —Å–¥–∞–Ω.

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /status –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.`);
        } else {
          ctx.reply(`‚ùå –û—à–∏–±–∫–∞: ${data.error}`);
        }
      }

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞:', error);
      ctx.reply(`üòî –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç—á–µ—Ç–∞.

–í–∞—à –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ:
"${reportText.substring(0, 200)}${reportText.length > 200 ? '...' : ''}"

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.`);
    }

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤ reportHandler:', error);
    ctx.reply('üòî –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç—á–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
}

module.exports = reportHandler; 